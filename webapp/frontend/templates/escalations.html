{% extends "index.html" %}

{% block header_title %}Escalations{% endblock %}

{% block content %}
<div x-data="escalationsPage()" x-init="init()">
    <!-- Header with Search -->
    <div class="card mb-6">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gradient">Escalations</h2>
                <p class="text-gray-400 text-sm mt-1">Browse and complete escalation contracts</p>
            </div>
            <div class="flex items-center space-x-3">
                <span class="badge badge-info" x-text="`${total} Available`"></span>
                <button
                    @click="unlockAll()"
                    :disabled="loading"
                    class="btn-primary">
                    <i class="fas fa-unlock mr-2"></i>
                    Complete All Escalations
                </button>
            </div>
        </div>

        <!-- Search Box -->
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input
                type="search"
                x-model="searchQuery"
                @input.debounce.300ms="search()"
                placeholder="Search escalations... (e.g., 'sapienza', 'surgeon')"
                class="input">
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-peacock-400 mb-4"></i>
        <p class="text-gray-400">Loading escalations...</p>
    </div>

    <!-- Selected Items Bar -->
    <div x-show="selectedItems.length > 0"
         x-transition
         class="card mb-6 bg-peacock-500/10 border-peacock-500/30">
        <div class="flex items-center justify-between">
            <span class="text-sm">
                <i class="fas fa-check-circle text-peacock-400 mr-2"></i>
                <span x-text="selectedItems.length"></span> escalation(s) selected
            </span>
            <div class="flex items-center space-x-3">
                <button
                    @click="selectedItems = []"
                    class="btn-secondary text-sm py-2">
                    Clear Selection
                </button>
                <button
                    @click="unlockSelected()"
                    class="btn-primary text-sm py-2">
                    <i class="fas fa-unlock mr-2"></i>
                    Complete Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Escalations Grid -->
    <div x-show="!loading" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="escalation in escalations" :key="escalation.id">
            <div class="card group cursor-pointer" @click="toggleSelect(escalation.id)">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <input
                            type="checkbox"
                            class="w-5 h-5 rounded border-gray-600 text-peacock-500 focus:ring-peacock-500"
                            :checked="selectedItems.includes(escalation.id)"
                            @click.stop="toggleSelect(escalation.id)">
                        <div>
                            <h4 class="font-semibold group-hover:text-peacock-400 transition" x-text="escalation.name"></h4>
                            <p class="text-xs text-gray-400" x-text="escalation.codename || escalation.id.substring(0, 8) + '...'"></p>
                        </div>
                    </div>
                    <span class="badge badge-success text-xs" x-text="escalation.location"></span>
                </div>

                <!-- Level Progress -->
                <div class="mb-4">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>Max Level</span>
                        <span x-text="`Level ${escalation.max_level}`" class="text-peacock-400 font-semibold"></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 100%"></div>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-4 border-t border-gray-700/50">
                    <span class="text-xs text-gray-400">
                        <i class="fas fa-layer-group text-orange-400 mr-1"></i>
                        <span x-text="`${escalation.max_level} Levels`"></span>
                    </span>
                    <button
                        @click.stop="unlockSingle(escalation.id)"
                        class="text-peacock-400 hover:text-peacock-300 text-sm">
                        <i class="fas fa-unlock"></i> Complete
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && escalations.length === 0" class="text-center py-12">
        <i class="fas fa-layer-group text-4xl text-gray-600 mb-4"></i>
        <p class="text-gray-400">No escalations found</p>
        <p class="text-sm text-gray-500 mt-2" x-show="searchQuery">Try a different search term</p>
    </div>
</div>

<script>
function escalationsPage() {
    return {
        escalations: [],
        total: 0,
        loading: true,
        searchQuery: '',
        selectedItems: [],

        async init() {
            await this.loadEscalations();
        },

        async loadEscalations() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                if (this.searchQuery) params.append('search', this.searchQuery);

                const response = await fetch(`/api/escalations?${params}`);
                const data = await response.json();

                if (data.status === 'success') {
                    this.escalations = data.escalations;
                    this.total = data.total;
                }
            } catch (error) {
                console.error('Error loading escalations:', error);
                toast.error('Failed to load escalations');
            }
            this.loading = false;
        },

        async search() {
            await this.loadEscalations();
        },

        toggleSelect(id) {
            const index = this.selectedItems.indexOf(id);
            if (index > -1) {
                this.selectedItems.splice(index, 1);
            } else {
                this.selectedItems.push(id);
            }
        },

        async unlockAll() {
            try {
                const response = await fetch('/api/unlock/escalations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_type: 'escalations', items: [] })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    toast.success(data.message);
                } else {
                    toast.error(data.message || 'Failed to complete escalations');
                }
            } catch (error) {
                toast.error('Failed to complete escalations');
            }
        },

        async unlockSelected() {
            if (this.selectedItems.length === 0) return;

            try {
                const response = await fetch('/api/unlock/escalations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_type: 'escalations', items: this.selectedItems })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    toast.success(`Completed ${this.selectedItems.length} escalations`);
                    this.selectedItems = [];
                } else {
                    toast.error(data.message || 'Failed to complete escalations');
                }
            } catch (error) {
                toast.error('Failed to complete escalations');
            }
        },

        async unlockSingle(id) {
            try {
                const response = await fetch('/api/unlock/escalations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_type: 'escalations', items: [id] })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    toast.success('Escalation completed!');
                } else {
                    toast.error(data.message || 'Failed to complete escalation');
                }
            } catch (error) {
                toast.error('Failed to complete escalation');
            }
        }
    }
}
</script>
{% endblock %}
